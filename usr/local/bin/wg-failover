#!/usr/bin/env bash
set -euo pipefail

CONFIG_FILE="/etc/wireguard/wg-failover.conf"
LOG_PREFIX="wg-failover"

log() {
  echo "${LOG_PREFIX}: $*"
}

parse_endpoint() {
  local endpoint="$1"
  local host=""
  local port=""

  if [[ "$endpoint" =~ ^\[([0-9a-fA-F:]+)\]:([0-9]+)$ ]]; then
    host="${BASH_REMATCH[1]}"
    port="${BASH_REMATCH[2]}"
  else
    host="${endpoint%:*}"
    port="${endpoint##*:}"
  fi

  printf '%s|%s' "$host" "$port"
}

resolve_host() {
  local host="$1"
  local resolved=""

  if [[ -z "$host" ]]; then
    echo ""
    return
  fi

  if [[ "$host" == *":"* ]]; then
    resolved="$(getent ahostsv6 "$host" 2>/dev/null | awk 'NR==1 {print $1}')"
  else
    resolved="$(getent ahostsv4 "$host" 2>/dev/null | awk 'NR==1 {print $1}')"
  fi

  if [[ -n "$resolved" ]]; then
    echo "$resolved"
  else
    echo "$host"
  fi
}

normalize_endpoint() {
  local endpoint="$1"
  local host=""
  local port=""

  IFS='|' read -r host port <<< "$(parse_endpoint "$endpoint")"
  host="$(resolve_host "$host")"
  if [[ "$host" == *":"* ]]; then
    printf '[%s]:%s' "$host" "$port"
  else
    printf '%s:%s' "$host" "$port"
  fi
}

is_reachable() {
  local host="$1"
  if [[ -z "$host" ]]; then
    return 1
  fi

  if [[ "$host" == *":"* ]]; then
    ping -6 -c1 -W1 "$host" >/dev/null 2>&1
  else
    ping -c1 -W1 "$host" >/dev/null 2>&1
  fi
}

apply_endpoint() {
  local iface="$1"
  local pubkey="$2"
  local endpoint="$3"

  if [[ -z "$endpoint" ]]; then
    return
  fi

  wg set "$iface" peer "$pubkey" endpoint "$endpoint"
}

current_endpoint() {
  local iface="$1"
  local pubkey="$2"

  wg show "$iface" endpoints 2>/dev/null | awk -v key="$pubkey" '$1 == key {print $2}'
}

main() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    log "Missing config: $CONFIG_FILE"
    exit 1
  fi

  # shellcheck source=/etc/wireguard/wg-failover.conf
  source "$CONFIG_FILE"

  if [[ -z "${INTERFACE:-}" ]]; then
    log "INTERFACE not set in $CONFIG_FILE"
    exit 1
  fi

  if [[ ${#PEERS[@]} -eq 0 ]]; then
    log "No peers defined in $CONFIG_FILE"
    exit 0
  fi

  for peer in "${PEERS[@]}"; do
    IFS='|' read -r name pubkey primary secondary <<< "$peer"
    if [[ -z "$pubkey" || -z "$primary" ]]; then
      log "Skipping $name due to missing pubkey or primary endpoint"
      continue
    fi

    current="$(current_endpoint "$INTERFACE" "$pubkey")"
    normalized_primary="$(normalize_endpoint "$primary")"
    IFS='|' read -r host _ <<< "$(parse_endpoint "$primary")"
    if is_reachable "$host"; then
      if [[ -n "$current" && "$current" != "$normalized_primary" ]]; then
        log "Restoring $name to $primary"
        apply_endpoint "$INTERFACE" "$pubkey" "$primary"
        exit 0
      fi
      continue
    fi

    if [[ -n "$secondary" ]]; then
      normalized_secondary="$(normalize_endpoint "$secondary")"
      IFS='|' read -r alt_host _ <<< "$(parse_endpoint "$secondary")"
      if is_reachable "$alt_host"; then
        if [[ "$current" != "$normalized_secondary" ]]; then
          log "Failing over $name to $secondary"
          apply_endpoint "$INTERFACE" "$pubkey" "$secondary"
          exit 0
        fi
      else
        log "Both endpoints unreachable for $name"
      fi
    else
      log "Primary endpoint unreachable for $name"
    fi
  done
}

main "$@"
